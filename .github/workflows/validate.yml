name: æ•°æ®éªŒè¯

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'data/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: éªŒè¯JSONæ ¼å¼
      run: |
        echo "éªŒè¯ plants.json æ ¼å¼..."
        node -e "JSON.parse(require('fs').readFileSync('data/plants.json', 'utf8'))"
        echo "âœ“ plants.json æ ¼å¼æ­£ç¡®"
        
        echo "éªŒè¯ species.json æ ¼å¼..."
        node -e "JSON.parse(require('fs').readFileSync('data/species.json', 'utf8'))"
        echo "âœ“ species.json æ ¼å¼æ­£ç¡®"
    
    - name: éªŒè¯æ•°æ®ç»“æ„
      run: |
        node -e "
        const plants = JSON.parse(require('fs').readFileSync('data/plants.json', 'utf8'));
        const species = JSON.parse(require('fs').readFileSync('data/species.json', 'utf8'));
        
        // éªŒè¯ plants æ•°æ®
        if (!Array.isArray(plants)) {
          throw new Error('plants.json å¿…é¡»æ˜¯æ•°ç»„');
        }
        
        plants.forEach((plant, index) => {
          if (!plant.name) {
            throw new Error(\`æ¤ç‰© #\${index} ç¼ºå°‘ name å­—æ®µ\`);
          }
          if (!plant.type || !['point', 'area'].includes(plant.type)) {
            throw new Error(\`æ¤ç‰© #\${index} çš„ type å­—æ®µæ— æ•ˆ\`);
          }
          if (plant.type === 'point' && !plant.position) {
            throw new Error(\`å•æ ªæ¤ç‰© #\${index} ç¼ºå°‘ position å­—æ®µ\`);
          }
          if (plant.type === 'area' && (!plant.path || plant.path.length < 3)) {
            throw new Error(\`åŒºåŸŸæ¤ç‰© #\${index} çš„ path å­—æ®µæ— æ•ˆï¼ˆè‡³å°‘éœ€è¦3ä¸ªç‚¹ï¼‰\`);
          }
        });
        
        // éªŒè¯ species æ•°æ®
        if (!Array.isArray(species)) {
          throw new Error('species.json å¿…é¡»æ˜¯æ•°ç»„');
        }
        
        species.forEach((s, index) => {
          if (!s.name) {
            throw new Error(\`ç‰©ç§ #\${index} ç¼ºå°‘ name å­—æ®µ\`);
          }
        });
        
        console.log('âœ“ æ•°æ®ç»“æ„éªŒè¯é€šè¿‡');
        console.log(\`- å…± \${plants.length} ä¸ªæ¤ç‰©\`);
        console.log(\`- å…± \${species.length} ä¸ªç‰©ç§\`);
        "
    
    - name: éªŒè¯é€šè¿‡
      if: success()
      run: echo "ğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼"
